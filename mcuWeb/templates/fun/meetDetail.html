{% extends "base.html" %}

{% load static %}

{% block title %}会议控制{% endblock %}

{% block csss %}
<link href="{% static "css/meetinglist.css" %}" rel="stylesheet" media="screen">
{% endblock %}

{% block content %}
<!-- 页标 -->
<div class="row-fluid">
	<div class="span8 offset1">
		<p>会议控制</p>
	</div>
</div>
<!-- 会议信息显示 -->
<div class="row-fluid">
	<div class="span10 offset1" id="meetinfo">
		<div class="row-fluid">
			<div class="span4">
				<p><strong>会议名称：</strong>{{meetInstance.name}}</p>
				<p><strong>带宽：</strong>{{meetInstance.bandwidth}}</p>
				<p><strong>视频分辨率：</strong>{{meetInstance.capalityname}}</p>
			</div>
			<div class="span4">
				<p><strong>会议编号：</strong>{{meetInstance.meetcode}}</p>
				<p><strong>视频协议：</strong>{{meetInstance.videoProtocol}}</p>
				<p><strong>音频协议：</strong>{{meetInstance.audioProtocol}}</p>
			</div>
			<div class="span4">
				<p><strong>会议备注：</strong>{{meetInstance.remark}}</p>
				<p><strong>视频帧率：</strong>{{meetInstance.videoFrameRate}}</p>
				<p><strong>主会场：</strong>{{meetInstance.mainMeetRoomName}}</p>

			</div>
		</div>
	</div>
</div>
<!-- 按钮框体 -->
<div class="row-fluid">
	<div class="span10 offset1" id="buttonbox">
		<div class="row-fluid" >
			<div id="modelselect">
				<form class="form-inline">
					<label>模式切换：</label>
					<select class="span3" id="modelmenu">
							<option value="0">管理员模式</option>
							<option value="1">主席模式</option>
							<option value="2">语音激励模式</option>
					</select>
					<a class="btn btn-info" onclick="modelfun()">确定</a>
				</form>
			</div>
			<div class="row-fluid" id="modelcontrol">
				<div class="span12" id="">
					<a class="btn btn-info">全部连接</a>
					<a class="btn btn-info">全部断开</a>
					<div id="title">
						<p>主席模式 </p>
					</div>
					<div id="title1"><p>语音激励模式</p></div>
				</div>
			</div>
		</div>

	</div>
</div>


<!-- 列表显示 -->
<div class="row-fluid">
	<div class="span10 offset1">
		<table class="table table-condensed">
			<div id="modelcover"></div>
			<thead>
				<tr>
					<th>#</th>
					<th>会场名称</th>
					<th>会场IP:</th>
					<th>连接状态</th>
					<th>连接</th>
					<th>断开</th>
					<th>静音</th>
					<th>闭麦</th>
					<th>双流</th>
					<th>查看</th>
					<th>广播</th>
				</tr>
			</thead>
			{% for terminal in terminalList %}
			<tbody>
				<tr id="tr{{terminal.pk}}">
					<td>{{ forloop.counter }}</td>
					<td>会场{{terminal.name}}</td>
					<td>{{terminal.terminalIP}}</td>
					<td class="unconnect" id="connect{{terminal.pk}}"><button></button></td>
					<td class="callmember1" id="callmember{{terminal.pk}}"><a class="btn" onclick="callmember({{terminal.pk}})"> </a></td>
					<td class="hangupforbid" id="hangup{{terminal.pk}}"><a class="btn" onclick="hangup({{terminal.pk}})"> </a></td>
					<td class="silencememberforbid" id="silencemember{{terminal.pk}}"><a class="btn" onclick="silencemember({{terminal.pk}})"> </a></td>
					<td class="shutupforbid" id="shutup{{terminal.pk}}"><a class="btn" onclick="shutup({{terminal.pk}})" > </a></td>
					<td class="doubleforbid" id="double{{terminal.pk}}"><a class="btn" onclick="double({{terminal.pk}})" > </a></td>
					<td class="seeforbid" id="see{{terminal.pk}}"><a class="btn" onclick="see({{terminal.pk}})" > </a></td>
					<td class="broadcastforbid" id="broadcast{{terminal.pk}}"><a class="btn" onclick="broadcast({{terminal.pk}})" > </a></td>
				</tr>
			</tbody>
			<script type="text/javascript">
			if({{meetInstance.mainMeetRoom}}==={{terminal.pk}}){
				$("#tr{{terminal.pk}}").addClass('main');
			}
			</script>

			{% endfor %}
		</table>
		<a type="button" class="btn" href="/meetinglist">返回</a>
	</div>
</div>


{% endblock %}

{% block js %}
<script type="text/javascript">
$('document').ready(function(){
	modellayout();
	$('div#pill2').attr('class','accordion-body collapse in');
	function getmeetmemberinfo() {
		$.get("/getinfolist/"+{{meetInstance.pk}}+"/",function(){

		});
	}

	$(function(){
		function getmeetinfo(){
			$.get("/getmeetinfo/"+{{meetInstance.pk}}+"/",function(info){
				var meetinfoJson= jQuery.parseJSON(info);

				for (var i = 0; i < meetinfoJson.AllMemberCount; i++) {
					fresh_icon(meetinfoJson.pk[i],meetinfoJson.MemberState[i],meetinfoJson.MemberAudioBlocking[i],meetinfoJson.MemberAudioMuting[i],meetinfoJson.MemberIdentity[i]);
					// if ((meetinfoJson.MemberState[i]==="0"||meetinfoJson.MemberState[i]==="1")&&($('#silencemember'+meetinfoJson.pk[i].toString()).hasClass('silencememberforbid'))) {
					// 	  lightup(meetinfoJson.pk[i]);
					// 	$('#connect'+meetinfoJson.pk[i].toString()).attr('class','connected');
					//   	$('#callmember'+meetinfoJson.pk[i].toString()).attr('class','callmemberforbid');
					//   	$('#hangup'+meetinfoJson.pk[i].toString()).attr('class','hangup1');
					// }
					// if ($('#silencemember'+meetinfoJson.pk[i].toString()).hasClass('silencememberforbid')) {
					// 	$('#silencemember'+meetinfoJson.pk[i].toString()).attr('class','silencemember0');
					// 	$('#shutup'+meetinfoJson.pk[i].toString()).attr('class','shutup0');
					// 	$('#double'+meetinfoJson.pk[i].toString()).attr('class','double0');
					// 	$('#see'+meetinfoJson.pk[i].toString()).attr('class','see0');
					// 	$('#broadcast'+meetinfoJson.pk[i].toString()).attr('class','broadcast0');
				}
			});
		}
		getmeetinfo();
		setInterval(getmeetinfo,2000);// 2秒状态轮询
	});
});

// function lightup(number) {
// 	$('#connect'+number.toString()).attr('class','connected');
// 	$('#callmember'+number.toString()).attr('class','callmemberforbid');
// 	$('#hangup'+number.toString()).attr('class','hangup1');
// 	$('#silencemember'+number.toString()).attr('class','silencemember0');
// 	$('#shutup'+number.toString()).attr('class','shutup0');
// 	$('#double'+number.toString()).attr('class','double0');
// 	$('#see'+number.toString()).attr('class','see0');
// 	$('#broadcast'+number.toString()).attr('class','broadcast0');

// }
function modelfun(){
	var num = $("#modelmenu").val();
	modellayout();
		$.get("/model/"+{{meetInstance.pk}}+"/"+ num+"/",function(){

		});
}

function modellayout(){
	var el = $("#modelmenu").val();
	if(el==="0"){
		$('#modelcover').hide();
		$('#title').hide();
		$('#title1').hide();
	}
	else if(el==="1"){
		$('#modelcover').show();
		$('#title').show();
		$('#title1').hide();
	}
	else{
		$('#modelcover').show();
		$('#title').hide();
		$('#title1').show();
	}
}

function fresh_icon(number,state,blocking,muting,identity){
	if (state==="0") {
		$('#connect'+number.toString()).attr('class','unconnect');
		$('#callmember'+number.toString()).attr('class','callmember1');
		$('#hangup'+number.toString()).attr('class','hangupforbid');
		$('#silencemember'+number.toString()).attr('class','silencememberforbid');
		$('#shutup'+number.toString()).attr('class','shutupforbid');
		$('#double'+number.toString()).attr('class','doubleforbid');
		$('#see'+number.toString()).attr('class','seeforbid');
		$('#broadcast'+number.toString()).attr('class','broadcastforbid');


	}
	else if (state==="1") {
			$('#connect'+number.toString()).attr('class','connected');
			$('#callmember'+number.toString()).attr('class','callmemberforbid');
			$('#hangup'+number.toString()).attr('class','hangup1');
			if ($('#double'+number.toString()).hasClass('doubleforbid')) {
				$('#double'+number.toString()).attr('class','double0');
			}
			if (blocking==="0") {                          //block是静音，mute是闭麦
				$('#silencemember'+number.toString()).attr('class','silencemember0');
			}
			else if (blocking==="1") {
				$('#silencemember'+number.toString()).attr('class','silencemember1');
			}
			if (muting==="0") {
				$('#shutup'+number.toString()).attr('class','shutup0');
			}
			else if (muting==="1") {
				$('#shutup'+number.toString()).attr('class','shutup1');
			}
			if (identity==="0") {	                          //0广播，1查看，2普通
				$('#broadcast'+number.toString()).attr('class','broadcast1');
				$('#see'+number.toString()).attr('class','see0');
			}
			else if (identity==="1") {	                          //0广播，1查看，2普通
				$('#see'+number.toString()).attr('class','see1');
				$('#broadcast'+number.toString()).attr('class','broadcast0');
			}
			else if (identity==="2") {	                          //0广播，1查看，2普通
				$('#broadcast'+number.toString()).attr('class','broadcast0');
				$('#see'+number.toString()).attr('class','see0');
			}
		}




}
function callmember(pk){
	console.log(pk);
	if ($('#callmember'+pk.toString()).hasClass('callmember1')) {
		$('#connect'+pk.toString()).attr('class','connecting');
		$.get("/callmember/"+ {{meetInstance.pk}}+"/" +pk+"/",function(results){
			var parsedJson = jQuery.parseJSON(results);
			fresh_icon(pk,parsedJson.MemberState,parsedJson.MemberAudioBlocking,parsedJson.MemberAudioMuting,parsedJson.MemberIdentity);
			// $('#double'+pk.toString()).attr('class','double0');
			// if(parsedJson.MemberState==="0"||parsedJson.MemberState==="1"){
			// 	lightup(pk);
			// }
		});
	}
};

function hangup(pk){
	if ($('#hangup'+pk.toString()).hasClass('hangup1')) {
		console.log(pk);
		$.get("/hangup/"+ {{meetInstance.pk}}+"/"+pk+"/",function(){
			$('#connect'+pk.toString()).attr('class','unconnect');
			$('#callmember'+pk.toString()).attr('class','callmember1');
			$('#hangup'+pk.toString()).attr('class','hangupforbid');
			$('#silencemember'+pk.toString()).attr('class','silencememberforbid');
			$('#shutup'+pk.toString()).attr('class','shutupforbid');
			$('#double'+pk.toString()).attr('class','doubleforbid');
			$('#see'+pk.toString()).attr('class','seeforbid');
			$('#broadcast'+pk.toString()).attr('class','broadcastforbid');
		});
	}
};

function silencemember(pk){
	console.log(pk);
	if($('#silencemember'+pk.toString()).hasClass('silencemember0')){
		$.get("/silencemember/"+ {{meetInstance.pk}}+"/"+pk+"/"+1+"/",function(results){
			// $('#silencemember'+pk.toString()).attr('class','silencemember1');
			var parsedJson = jQuery.parseJSON(results);
			fresh_icon(pk,parsedJson.MemberState,parsedJson.MemberAudioBlocking,parsedJson.MemberAudioMuting,parsedJson.MemberIdentity);
		});
	}
	else if($('#silencemember'+pk.toString()).hasClass('silencemember1')){
		$.get("/silencemember/"+ {{meetInstance.pk}}+"/"+pk+"/"+0+"/",function(results){
			// $('#silencemember'+pk.toString()).attr('class','silencemember0');
			var parsedJson = jQuery.parseJSON(results);
			fresh_icon(pk,parsedJson.MemberState,parsedJson.MemberAudioBlocking,parsedJson.MemberAudioMuting,parsedJson.MemberIdentity);

		});
	}
};

function shutup(pk){
	console.log(pk);
	if($('#shutup'+pk.toString()).hasClass('shutup0')){
		$.get("/shutup/"+ {{meetInstance.pk}}+"/"+pk+"/"+1+"/",function(results){
			// $('#shutup'+pk.toString()).attr('class','shutup1');
			var parsedJson = jQuery.parseJSON(results);
			fresh_icon(pk,parsedJson.MemberState,parsedJson.MemberAudioBlocking,parsedJson.MemberAudioMuting,parsedJson.MemberIdentity);
		});
	}
	else if($('#shutup'+pk.toString()).hasClass('shutup1')){
		$.get("/shutup/"+ {{meetInstance.pk}}+"/"+pk+"/"+0+"/",function(results){
			// $('#shutup'+pk.toString()).attr('class','shutup0');
			var parsedJson = jQuery.parseJSON(results);
			fresh_icon(pk,parsedJson.MemberState,parsedJson.MemberAudioBlocking,parsedJson.MemberAudioMuting,parsedJson.MemberIdentity);
		});
	}
};

function double(pk){
	console.log(pk);
	if($('#double'+pk.toString()).hasClass('double0')){
		$.get("/double/"+ {{meetInstance.pk}}+"/"+pk+"/"+1+"/",function(results){
			$('.double1').attr('class','double0');
			$('#double'+pk.toString()).attr('class','double1');
			var parsedJson = jQuery.parseJSON(results);
			fresh_icon(pk,parsedJson.MemberState,parsedJson.MemberAudioBlocking,parsedJson.MemberAudioMuting,parsedJson.MemberIdentity);
		});
	}
	else if($('#double'+pk.toString()).hasClass('double1')){
		$.get("/double/"+ {{meetInstance.pk}}+"/"+pk+"/"+0+"/",function(results){
			$('#double'+pk.toString()).attr('class','double0');
			var parsedJson = jQuery.parseJSON(results);
			fresh_icon(pk,parsedJson.MemberState,parsedJson.MemberAudioBlocking,parsedJson.MemberAudioMuting,parsedJson.MemberIdentity);
		});
	}
};

function see(pk){
	if ($('#see'+pk.toString()).hasClass('see0')) {
		$.get("/see/"+ {{meetInstance.pk}}+"/"+pk+"/"+1+"/",function(results){
			// $('.see1').attr('class','see0');
			// $('.broadcast1').attr('class','broadcast0');
			// $('#see'+pk.toString()).attr('class','see1');
			var parsedJson = jQuery.parseJSON(results);
			fresh_icon(pk,parsedJson.MemberState,parsedJson.MemberAudioBlocking,parsedJson.MemberAudioMuting,parsedJson.MemberIdentity);
		});
	}
};

function broadcast(pk){
	if ($('#broadcast'+pk.toString()).hasClass('broadcast0')) {
		$.get("/broadcast/"+ {{meetInstance.pk}}+"/"+pk+"/"+1+"/",function(results){
			// $('.see1').attr('class','see0');
			// $('.broadcast1').attr('class','broadcast0');
			// $('#broadcast'+pk.toString()).attr('class','broadcast1');
			var parsedJson = jQuery.parseJSON(results);
			fresh_icon(pk,parsedJson.MemberState,parsedJson.MemberAudioBlocking,parsedJson.MemberAudioMuting,parsedJson.MemberIdentity);
		});
	}
};
</script>
{% endblock %}
